## dns

### dns解析过程
我们通过用户在浏览器的地址栏敲入了网站的网址的DNS解析为例子

1. 查找浏览器缓存: 浏览器会检查缓存中有没有这个域名对应解析过的IP地址,如果缓存中有,这个解析过程就将结束。但是浏览器缓存的域名也是有大小/时间限制的。
2. 查找系统缓存: 如果用户的浏览器缓存中没有,浏览器会查找操作系统缓存中是否有这个域名对应的DNS解析过程。即查找host文件,你可以将域名解析到任何能够访问的IP地址,如果你指定了域名对应的IP地址,浏览器会优先访问这个IP,但是黑客有可能劫持你的HOST文件,将你的域名解析到特定的IP地址上.
3. 查找路由器缓存,如果系统缓存中也找不到那就是路由器缓存了
4. 查找ISP DNS缓存如果还没能够查找到,那就只能查找ISP DNS缓存了。在我们的网络配置中,通常都会有DNS服务器地址这一栏,操作系统会把这个域名发送给这里设置的DNS,也就是本地区的域名服务器,通常是提供给你接入互联网的应用提供商。这个专门的域名解析服务器性能都会很好,他们一般都会缓存域名解析结果,当然缓存的时间都是受控制的,80%的域名在这里都能解析完成
5. 递归查询: 如果在前面都没有办法命中DNS缓存的情况下,将会有下列操作
   - 本地DNS服务器将所要查询的请求转发到互联网的根域
   - 根域将所要查询域名的顶级域(比如要查询baidu.com那么顶级域就是com)的服务器IP地址返回到本地DNS
   - 本地DNS根据返回的IP地址,再向顶级域发送请求
   - com域服务器将域名中的二级域的ip地址返回给本地DNS
   - 本地DNS再向二级发送请求查询
   - 不断重复这个过程直到查到最终的结果。这个时候主机才能通过ip访问到主机

### 递归查询和迭代查询
1. 本机向本地域名服务器的查询一般都是使用递归查询

2. 本地域名服务器向根域名服务器的查询的迭代查询


3. 总结: 
- 递归查询: 客户端只发出一次请求,要求对方给出最终结果
- 迭代查询: 客户端发出一次请求,如果对方没有授权回答,他就会返回一个能解答这个查询的其他名称服务器列表,客户端会再向返回的列表中发出请求,直到找到最终负责所查询域名的名称服务器,从它得到最终结果
- 授权回答: 向dns服务器查询一个域名, 刚好这个域名是本服务器负责,返回的结果就是授权回答

从递归和迭代查询可以看出: 
- 客户端-本地dns服务端: 这是属于递归查询
- 本地dns服务器-外网: 这部分属于迭代查询
- 递归查询时,返回的结果只有两种: 查询成功和查询失败
- 迭代查询,又称作重指引,返回的是最佳查询点或者主机地址
### DNS有关的安全问题
1. DNS欺骗: DNS欺骗即域名信息欺骗,这是个最常见的DNS安全问题。当一个DNS服务器掉入陷阱,使用了来自一个恶意的DNS服务器的错误信息,那么该DNS就被欺骗了。DNS欺骗会使那些易受攻击的DNS服务器产生许多安全问题,例如: 将用户引导到错误的互联网站点,或发送一个电子邮件到一个未经授权的邮件服务器。网络攻击通常通过两种方式进行DNS欺骗
- 缓存感染: 黑客会熟练的使用DNS请求,将一个数据放入没有设防的DNS服务器的缓存中。这些缓存信息会在客户进行DNS访问的时候返回给客户,从而将客户引导到入侵者所设置的运行木马的WEB服务器或邮件服务器上,然后黑客从这些服务器上获取用户信息
- DNS信息劫持: 入侵者通过监听客户端和DNS服务器的对话,通过猜测服务器响应给客户端的DNS查询ID。每个DNS报文包括一个相关联的16位ID号,DNS服务器根据这个ID号获取请求源位置。黑客在服务器之前将虚假的响应交给用户,从而欺骗客户端去访问恶意的网站
- DNS重定向: 攻击者能够将DNS名称查询重定向到恶意DNS服务器.这样攻击者就能获得DNS服务器的写权限
2. 拒绝服务攻击: 黑客主要利用一些DNS软件的漏洞,比如BIND 9版本,如果有人给BIND设备发送特定的DNS数据包请求,BIND就会自动关闭。
3. 分布式拒绝服务攻击: DDOS攻击通过攻击者控制的几十台或者几百台计算机攻击一台主机,使得服务攻击更加难以防范,更难以通过阻塞单一攻击源主机的数据流,来防范服务拒绝攻击
4. 缓冲区漏洞溢出攻击: 利用DNS服务器软件存在漏洞,构建畸形数据包来对DNS服务器进行缓冲区溢出攻击。如果这一攻击成功,就会造成DNS服务停止,或者攻击者能够在DNS服务器上执行设定的任意代码
### DNS有关的网络性能优化
1. 减少DNS查找: 避免重定向、浏览器DNS缓存、服务器DNS缓存、使用keep-alive或者多路复用特性。考虑影响DNS缓存的因素
- 服务器可以设置TLL值表示DNS记录的存活时间。本机DNS缓存将根据这个TTL值判断DNS记录什么时候被抛弃,这个TTL值一般都不会设置很大,主要是考虑快速故障转移的问题
- 浏览器DNS缓存也有自己的过期时间,这个时间是独立于本机DNS缓存的,相对时间也较短.
- 浏览器记录DNS的数量也有限制,如果短时间内访问了大量不同的网站,较早的DNS将被抛弃,必须重新查找。不过就算浏览器丢弃了,操作系统DNS也有很大几率保存着该记录,这样可以避免通过网络查询而带来的延迟
2. DNS的预解析
- 可以通过meta信息来告知浏览器,我这个页面要做DNS预解析(connect on代表开启off代表关闭,这个预解析会主动解析文档内所有链接的,无论是图片/css还是js的)
```
<meta http-equiv="x-dns-prefetch-control" content="on">
```
- 可以使用link标签来强制对DNS做预解析
```
<link rel="dns-prefetch" href="http://xxx.xx.xx">
```
- 当客户端DNS缓存为空时,DNS查找的数量与Web页面中唯一主机名的数量相等。唯一减少主机名的数量就可以减少DNS查找的数量,较少的域名来减少DNS查找